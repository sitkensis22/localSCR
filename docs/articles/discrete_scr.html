<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Discrete SCR models: discrete state-space and marked individuals • localSCR</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Discrete SCR models: discrete state-space and marked individuals"><meta property="og:description" content="Learn how to simulate and analyze discrete spatial capture-recapture data 
"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">localSCR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/classic_scr.html">Classic SCR models: continuous state-space and marked individuals</a>
    </li>
    <li>
      <a href="../articles/discrete_scr.html">Discrete SCR models: discrete state-space and marked individuals</a>
    </li>
    <li>
      <a href="../articles/local_classic_scr.html">Local classic SCR models: continuous state-space and marked individuals</a>
    </li>
    <li>
      <a href="../articles/mark_resight_scr.html">Mark-resight models: continuous state-space with both marked and unmarked individuals</a>
    </li>
    <li>
      <a href="../articles/unmarked_scr.html">Spatial count models: continuous state-space and unmarked individuals</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>




<script src="discrete_scr_files/accessible-code-block-0.0.1/empty-anchor.js"></script>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Discrete SCR models: discrete state-space and marked individuals</h1>
                        <h4 data-toc-skip class="author">Daniel Eacker</h4>
            
            <h4 data-toc-skip class="date">2022-05-14</h4>
      
      
      <div class="hidden name"><code>discrete_scr.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>
The forth vignette of the ‘localSCR’ package covers a set of ‘discrete’ Bayesian spatial capture-recapture (SCR) models (Royle et al. 2014). These inhomogenous point process models are designed to model SCR data for ‘marked’ or ‘unmarked’ individuals and model the spatial density of activity centers as a function of some environmental covariate, for instance. Although many distance detection functions are possible, the package currently includes only a bivariate normal model of space use, which is commonly employed in the literature. The package is meant to ease implementation of Bayesian SCR models using the ‘nimble’ package (de Valpine et a. 2022), which allows for increased flexibilty with the ability for the user to include custom functions and assign different algorithms to specific model parameters. I took advantage of this functionality with the goal of building a simple, straightforward workflow that was flexible enough to handle most mainstream SCR analysis problems. Visit <a href="https://r-nimble.org/download" class="uri">https://r-nimble.org/download</a> for information on installing ‘nimble’ and Rtools on your computer.
</p>
<p><br></p>
</div>
<div id="implementation" class="section level2">
<h2>Implementation</h2>
<p>
<p>The ‘localSCR’ package implements Bayesian SCR models using the ‘nimble’ package (de Valpine et a. 2022) following methods described in Royle et al. (2014). We take advantage of recent developments in computation of SCR models. In this tutorial, two methods are implemented to decrease computational run time:</p>
<ol style="list-style-type: decimal">
<li>Using vectorized declarations for traps in distance function calculations</li>
<li>Separating the data augmentation process into two steps (Chandler 2018)</li>
</ol>
<p>In some SCR problems, there are landscape features that create ‘unsuitable’ habitat for the study species. Habitat masks are used to account for these features and designate suitable (1) or unsuitable (0) habitat, and can be represented as a matrix or array of binary values. This restricts the possible locations of latent activity centers to only suitable habitat, and in our discrete problem we simply exclude the unsuitable pixels and keep track of the cell indexes. The ‘localSCR’ package provides functions to construct a habitat mask from either raster or polygon data. In the discrete model, we’ll use the habitat mask to limit the ‘pixels’ or ‘cells’ of our discrete state-space, such that only available cells will be sampled.</p>
Finally, in some SCR designs, clusters of trap arrays may be spread out over the study area such that individuals can only be detected at one of multiple trap arrays (e.g., Furnas et al. 2018). This necessitates including the traps as a 3-dimensional array, using a site identifier to track which site a detected or augmented individual belongs to, and using a dynamic indexing in the model.
</p>
<br>
<p>
</div>
<div id="functions-used-from-localscr-package" class="section level2">
<h2>Functions used from ‘localSCR’ package:</h2>
<ul>
<li><code>get_discrete()</code> grabs template model for given inputs using the <code>nimbleCode()</code> function</li>
<li><code>grid_classic()</code> define state-space grid and extent</li>
<li><code>initialize_classic()</code> generate starting locations for activity area centers</li>
<li><code>mask_polygon()</code> create habitat mask matrix or array from polygon</li>
<li><code>nimSummary()</code> summarize lists of Markov Chain Monte Carlo (MCMC) output</li>
<li><code>realized_density()</code> generate realized density surface from MCMC output</li>
<li><code>run_discrete()</code> wrapper function to run discrete models using ‘nimble’ package</li>
<li><code>sim_classic()</code> simulate basic spatial capture-recapture data</li>
</ul>
</p>
<p><br></p>
</div>
<div id="turtorial" class="section level2">
<h2>Turtorial</h2>
<p>This tutorial includes three parts:</p>
<ol style="list-style-type: decimal">
<li>Create ‘classic’ SCR data and convert to discretized format</li>
<li>Workflow for discrete SCR model for marked individuals using a 2D trap array, a single scaling parameter and habitat mask</li>
<li>Workflow for discrete SCR model for marked individuals using a 3D trap array,a single scaling parameter and habitat mask</li>
</ol>
</p>
<br>
<p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># load &#39;localSCR&#39; package</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(localSCR)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#&gt; Loading required package: nimble</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&gt; nimble version 0.12.2 is loaded.</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#&gt; For more information on NIMBLE and a User Manual,</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#&gt; please visit https://R-nimble.org.</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&gt; </span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt; Attaching package: &#39;nimble&#39;</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt; The following object is masked from &#39;package:stats&#39;:</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt; </span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt;     simulate</span></span></code></pre></div>
<p><br></p>
<div id="create-classic-scr-data-and-convert-to-discretized-format" class="section level3">
<h3>(1) Create ‘classic’ SCR data and convert to discretized format</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># simulate a single trap array with random positional noise</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">800</span>, <span class="dv">800</span>, <span class="dt">length.out =</span> <span class="dv">5</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>y &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">800</span>, <span class="dv">800</span>, <span class="dt">length.out =</span> <span class="dv">5</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a>traps &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">expand.grid</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y))</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">set.seed</span>(<span class="dv">200</span>)</span>
<span id="cb2-6"><a href="#cb2-6"></a>traps &lt;-<span class="st"> </span>traps <span class="op">+</span><span class="st"> </span><span class="kw">runif</span>(<span class="kw">prod</span>(<span class="kw">dim</span>(traps)),<span class="op">-</span><span class="dv">20</span>,<span class="dv">20</span>) </span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a>mysigma =<span class="st"> </span><span class="kw">c</span>(<span class="dv">300</span>) <span class="co"># simulate sex-specific scaling parameter</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>mycrs =<span class="st"> </span><span class="dv">32608</span> <span class="co"># EPSG for WGS 84 / UTM zone 8N</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>pixelWidth =<span class="st"> </span><span class="dv">200</span> <span class="co"># store pixelWidth or grid resolution</span></span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co"># create state-space</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>Grid =<span class="st"> </span><span class="kw">grid_classic</span>(<span class="dt">X =</span> traps, <span class="dt">crs_ =</span> mycrs, <span class="dt">buff =</span> <span class="dv">3</span><span class="op">*</span>mysigma, </span>
<span id="cb2-14"><a href="#cb2-14"></a>                    <span class="dt">res =</span> pixelWidth)</span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># create polygon for mask</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="kw">library</span>(sf)</span>
<span id="cb2-18"><a href="#cb2-18"></a>poly =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_polygon</span>(<span class="dt">x=</span><span class="kw">list</span>(<span class="kw">matrix</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1765</span>,<span class="op">-</span><span class="dv">1765</span>,<span class="dv">1730</span>,<span class="op">-</span><span class="dv">1650</span>,<span class="dv">1600</span>,</span>
<span id="cb2-19"><a href="#cb2-19"></a>              <span class="dv">1650</span>,<span class="dv">0</span>,<span class="dv">1350</span>,<span class="op">-</span><span class="dv">800</span>,<span class="dv">1700</span>,<span class="op">-</span><span class="dv">1850</span>,<span class="dv">1000</span>,<span class="op">-</span><span class="dv">1765</span>,<span class="op">-</span><span class="dv">1765</span>)</span>
<span id="cb2-20"><a href="#cb2-20"></a>            ,<span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>))), <span class="dt">crs =</span>  mycrs)</span>
<span id="cb2-21"><a href="#cb2-21"></a></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co"># create habitat mask</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>hab_mask =<span class="st"> </span><span class="kw">mask_polygon</span>(<span class="dt">poly =</span> poly, <span class="dt">grid =</span> Grid<span class="op">$</span>grid, <span class="dt">crs_ =</span> mycrs, </span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="dt">prev_mask =</span> <span class="ot">NULL</span>)</span>
<span id="cb2-25"><a href="#cb2-25"></a></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="co"># Simulated abundance</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>Nsim =<span class="st"> </span><span class="dv">200</span></span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co"># simulate data for uniform state-space and habitat mask</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>data3d =<span class="st"> </span><span class="kw">sim_classic</span>(<span class="dt">X =</span> traps, <span class="dt">ext =</span> Grid<span class="op">$</span>ext, <span class="dt">crs_ =</span> mycrs, </span>
<span id="cb2-31"><a href="#cb2-31"></a>                     <span class="dt">sigma_ =</span> mysigma,  <span class="dt">prop_sex =</span> <span class="dv">1</span>, <span class="dt">N =</span> Nsim, <span class="dt">K =</span> <span class="dv">4</span>, </span>
<span id="cb2-32"><a href="#cb2-32"></a>                     <span class="dt">base_encounter =</span> <span class="fl">0.15</span>,<span class="dt">enc_dist =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb2-33"><a href="#cb2-33"></a>                     <span class="dt">hab_mask =</span> hab_mask, <span class="dt">setSeed =</span> <span class="dv">200</span>)</span>
<span id="cb2-34"><a href="#cb2-34"></a></span>
<span id="cb2-35"><a href="#cb2-35"></a><span class="co"># total augmented population size </span></span>
<span id="cb2-36"><a href="#cb2-36"></a>M =<span class="st"> </span><span class="dv">400</span></span>
<span id="cb2-37"><a href="#cb2-37"></a></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="co"># get initial activity center starting values</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>s.st =<span class="st"> </span><span class="kw">initialize_classic</span>(<span class="dt">y=</span>data3d<span class="op">$</span>y, <span class="dt">M=</span>M, <span class="dt">X=</span>traps, <span class="dt">ext =</span> Grid<span class="op">$</span>ext, </span>
<span id="cb2-40"><a href="#cb2-40"></a>                            <span class="dt">hab_mask =</span> hab_mask)</span>
<span id="cb2-41"><a href="#cb2-41"></a></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="co"># convert traps and starting locations to discrete format</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>d_list =<span class="st"> </span><span class="kw">discretize_classic</span>(<span class="dt">X=</span>traps, <span class="dt">grid =</span> Grid<span class="op">$</span>grid, <span class="dt">s.st =</span> s.st, </span>
<span id="cb2-44"><a href="#cb2-44"></a>                            <span class="dt">crs_ =</span> mycrs, <span class="dt">hab_mask =</span> hab_mask)</span>
<span id="cb2-45"><a href="#cb2-45"></a></span>
<span id="cb2-46"><a href="#cb2-46"></a><span class="co"># inspect discrete data list</span></span>
<span id="cb2-47"><a href="#cb2-47"></a><span class="kw">str</span>(d_list)</span>
<span id="cb2-48"><a href="#cb2-48"></a><span class="co">#&gt; List of 4</span></span>
<span id="cb2-49"><a href="#cb2-49"></a><span class="co">#&gt;  $ grid: num [1:270, 1:2] -808 -608 1592 -1208 -1008 ...</span></span>
<span id="cb2-50"><a href="#cb2-50"></a><span class="co">#&gt;   ..- attr(*, &quot;dimnames&quot;)=List of 2</span></span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="co">#&gt;   .. ..$ : NULL</span></span>
<span id="cb2-52"><a href="#cb2-52"></a><span class="co">#&gt;   .. ..$ : chr [1:2] &quot;x&quot; &quot;y&quot;</span></span>
<span id="cb2-53"><a href="#cb2-53"></a><span class="co">#&gt;  $ nPix: int 270</span></span>
<span id="cb2-54"><a href="#cb2-54"></a><span class="co">#&gt;  $ X   : num [1:25, 1:2] -807.71 -407.71 -7.71 392.29 792.29 ...</span></span>
<span id="cb2-55"><a href="#cb2-55"></a><span class="co">#&gt;   ..- attr(*, &quot;dimnames&quot;)=List of 2</span></span>
<span id="cb2-56"><a href="#cb2-56"></a><span class="co">#&gt;   .. ..$ : NULL</span></span>
<span id="cb2-57"><a href="#cb2-57"></a><span class="co">#&gt;   .. ..$ : chr [1:2] &quot;x&quot; &quot;y&quot;</span></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="co">#&gt;  $ s.st: int [1:400] 174 194 54 178 130 91 156 163 190 193 ...</span></span>
<span id="cb2-59"><a href="#cb2-59"></a></span>
<span id="cb2-60"><a href="#cb2-60"></a><span class="co"># make ggplot of grid, and discretized trap locations </span></span>
<span id="cb2-61"><a href="#cb2-61"></a><span class="co"># and starting activity center locations</span></span>
<span id="cb2-62"><a href="#cb2-62"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb2-63"><a href="#cb2-63"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">as.data.frame</span>(d_list<span class="op">$</span>grid),<span class="kw">aes</span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y),</span>
<span id="cb2-64"><a href="#cb2-64"></a>                      <span class="dt">color=</span><span class="st">&quot;grey60&quot;</span>,<span class="dt">size=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb2-65"><a href="#cb2-65"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">as.data.frame</span>(d_list<span class="op">$</span>X),<span class="kw">aes</span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y),<span class="dt">color=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span></span>
<span id="cb2-66"><a href="#cb2-66"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">as.data.frame</span>(d_list<span class="op">$</span>grid[d_list<span class="op">$</span>s.st,]),</span>
<span id="cb2-67"><a href="#cb2-67"></a>               <span class="kw">aes</span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y),<span class="dt">color=</span><span class="st">&quot;orangered&quot;</span>,<span class="dt">size=</span><span class="fl">0.75</span>) <span class="op">+</span></span>
<span id="cb2-68"><a href="#cb2-68"></a><span class="st">    </span><span class="kw">theme_classic</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Northing&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Easting&quot;</span>) <span class="op">+</span></span>
<span id="cb2-69"><a href="#cb2-69"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),</span>
<span id="cb2-70"><a href="#cb2-70"></a>          <span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">16</span>))</span></code></pre></div>
<p align="center">
<img src="../man/figures/vignette_04/Fig1.png" style="width:70%"/>
</p>
<p>
<p><br> Here, we can see the state-space grid that was created after converting the state-space grid, traps, and initial activity centers using <code>discretize_classic()</code>. In the figure above, the state-space <code>grid</code> is reduced after applying a habitat mask (i.e., the number of rows was decreased) and is plotted with light gray points. Also, we can see that both the the traps <code>X</code> (shown as blue points) and initial activity centers <code>s.st</code> (shown as orange-red points) are discretized and overlap with the grid locations. We see that the function returns a list of revised grid based on the habitat mask <code>grid</code>, the number of available pixels <code>nPix</code>, the discretized trap locations <code>X</code>, and the grid indices for discretized initial activity center locations <code>s.st</code> as a vector.</p>
<p>In this example, We arbitrarily chose a grid resolution of 200 in this example (i.g., <code>res = 200</code>) to save model run time when creating the initial state-space using <code>grid_classic()</code>, but this will vary by problem. In situations involving habitat masks or discrete models, it is prudent to test the effect of different grid resolutions on the estimated abundance and density in SCR models (see Royle et al. 2014). Also, note the use to the EPSG code to define the coordinate reference system for our state-space (see <a href="https://epsg.io/32608" class="uri">https://epsg.io/32608</a>).</p>
<p>We also simulated some spatial capture-recapture data using <code>sim_classic()</code>. Above, we simulated a ‘true’ population size of 200 individuals (<code>N = 200</code>), 4 sampling occasions (<code>K = 4</code>), a single scaling parameter (<code>sigma_</code>) of 300 m, a baseline encounter probability of 0.15 (<code>base_encounter = 0.15</code>), the proportion of females (for example) (<code>prop_sex = 0.6</code>), a binomial encounter distribution (<code>enc_dist = "binomial"</code>) and we used our habitat mask (<code>hab_mask = hab_mask</code>). We also use <code>setSeed = 100</code> to make the simulation reproducible. We provide the function the extent of the state-space output from <code>grid_classic()</code> as <code>ext = Grid$ext</code>. Note that Grid is a list.</p>
<p>Next, we’ll use these data components we created above in a discrete SCR model. The package includes a set of template discrete SCR models that we will use to run the simple example. Note that since we won’t directly use <code>hab_mask</code> in the model, we won’t include it as a data component. Rather, it is accounted for by deleting the coordinates in the <code>grid</code> that are unsuitable habitat (i.e., <code>hab_mask = 0</code>). Also, it would be easy to modify the model code if covariates were available to model density or the detection process.</p>
</p>
<p><br></p>
</div>
<div id="workflow-for-discrete-scr-model-for-marked-individuals-using-a-2d-trap-array-single-scaling-parameter-and-habitat-mask" class="section level3">
<h3>(2) Workflow for discrete SCR model for marked individuals using a 2D trap array, single scaling parameter and habitat mask</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># prepare data</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>data =<span class="st"> </span><span class="kw">list</span>(<span class="dt">y=</span>data3d<span class="op">$</span>y)</span>
<span id="cb3-3"><a href="#cb3-3"></a>data<span class="op">$</span>y =<span class="st"> </span>data<span class="op">$</span>y[<span class="kw">which</span>(<span class="kw">apply</span>(data<span class="op">$</span>y, <span class="dv">1</span>, sum)<span class="op">!=</span><span class="dv">0</span>),,] <span class="co"># remove augmented records </span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># covert to 2d by summing over individuals and traps</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>data<span class="op">$</span>y =<span class="st"> </span><span class="kw">apply</span>(data<span class="op">$</span>y, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), sum) </span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># add discretized traps</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>data<span class="op">$</span>X =<span class="st"> </span>d_list<span class="op">$</span>X<span class="op">/</span><span class="dv">1000</span> <span class="co"># convert to km units</span></span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"># add grid</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>data<span class="op">$</span>grid =<span class="st"> </span>d_list<span class="op">$</span>grid<span class="op">/</span><span class="dv">1000</span> <span class="co"># convert to km units</span></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co"># prepare constants (note that density is now in activity centers/km2 </span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co"># and each cell is now 0.01 km2 in area</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>constants =<span class="st"> </span><span class="kw">list</span>(<span class="dt">M =</span> M,<span class="dt">n0 =</span> <span class="kw">nrow</span>(data<span class="op">$</span>y),<span class="dt">J=</span><span class="kw">dim</span>(data<span class="op">$</span>y)[<span class="dv">2</span>], </span>
<span id="cb3-16"><a href="#cb3-16"></a>                 <span class="dt">K=</span><span class="kw">dim</span>(data3d<span class="op">$</span>y)[<span class="dv">3</span>],<span class="dt">nPix=</span>d_list<span class="op">$</span>nPix,<span class="dt">pixArea =</span> (pixelWidth<span class="op">/</span><span class="dv">1000</span>)<span class="op">^</span><span class="dv">2</span>,</span>
<span id="cb3-17"><a href="#cb3-17"></a>                 <span class="dt">sigma_upper =</span> <span class="dv">1</span>, <span class="dt">A =</span> <span class="kw">sum</span>(hab_mask)<span class="op">*</span>((pixelWidth<span class="op">/</span><span class="dv">1000</span>)<span class="op">^</span><span class="dv">2</span>))</span>
<span id="cb3-18"><a href="#cb3-18"></a></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co"># add z and zeros vector data for latent inclusion indicator</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>data<span class="op">$</span>z =<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>,constants<span class="op">$</span>n0),<span class="kw">rep</span>(<span class="ot">NA</span>,constants<span class="op">$</span>M <span class="op">-</span><span class="st"> </span>constants<span class="op">$</span>n0))</span>
<span id="cb3-21"><a href="#cb3-21"></a>data<span class="op">$</span>zeros =<span class="st">  </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="ot">NA</span>,constants<span class="op">$</span>n0),<span class="kw">rep</span>(<span class="dv">0</span>,constants<span class="op">$</span>M <span class="op">-</span><span class="st"> </span>constants<span class="op">$</span>n0))</span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co"># define all initial values </span></span>
<span id="cb3-24"><a href="#cb3-24"></a>inits =<span class="st"> </span><span class="kw">list</span>(<span class="dt">sigma =</span> <span class="kw">runif</span>(<span class="dv">1</span>, <span class="fl">0.250</span>, <span class="fl">0.350</span>), <span class="dt">s =</span> d_list<span class="op">$</span>s.st,</span>
<span id="cb3-25"><a href="#cb3-25"></a>            <span class="dt">alpha0 =</span> <span class="fl">2.8</span>, <span class="dt">p0 =</span> <span class="kw">runif</span>(<span class="dv">1</span>, <span class="fl">0.05</span>, <span class="fl">0.15</span>),</span>
<span id="cb3-26"><a href="#cb3-26"></a>            <span class="dt">z=</span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="ot">NA</span>,constants<span class="op">$</span>n0),<span class="kw">rep</span>(<span class="dv">0</span>,constants<span class="op">$</span>M<span class="op">-</span>constants<span class="op">$</span>n0)))</span>
<span id="cb3-27"><a href="#cb3-27"></a></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="co"># parameters to monitor</span></span>
<span id="cb3-29"><a href="#cb3-29"></a>params =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sigma&quot;</span>,<span class="st">&quot;psi&quot;</span>,<span class="st">&quot;p0&quot;</span>,<span class="st">&quot;N&quot;</span>,<span class="st">&quot;D&quot;</span>,<span class="st">&quot;EN&quot;</span>,<span class="st">&quot;alpha0&quot;</span>,<span class="st">&quot;s&quot;</span>,<span class="st">&quot;z&quot;</span>)</span>
<span id="cb3-30"><a href="#cb3-30"></a></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co"># get model</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>discrete_model =<span class="st"> </span><span class="kw">get_discrete</span>(<span class="dt">type=</span><span class="st">&quot;marked&quot;</span>,<span class="dt">dim_y =</span> <span class="dv">2</span>, </span>
<span id="cb3-33"><a href="#cb3-33"></a>              <span class="dt">enc_dist =</span> <span class="st">&quot;binomial&quot;</span>,<span class="dt">sex_sigma =</span> <span class="ot">FALSE</span>,</span>
<span id="cb3-34"><a href="#cb3-34"></a>              <span class="dt">trapsClustered=</span><span class="ot">FALSE</span>)</span>
<span id="cb3-35"><a href="#cb3-35"></a></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="co"># show model (not run)</span></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="co"># discrete_model</span></span>
<span id="cb3-38"><a href="#cb3-38"></a></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="co"># run model (note this was run on a Mac with 16 GB 2667 MHz DDR4 </span></span>
<span id="cb3-40"><a href="#cb3-40"></a><span class="co"># and 2.3 GHz 8-Core Intel Core i9)</span></span>
<span id="cb3-41"><a href="#cb3-41"></a><span class="kw">library</span>(tictoc)</span>
<span id="cb3-42"><a href="#cb3-42"></a><span class="kw">tic</span>() <span class="co"># track time elapsed</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>out =<span class="st"> </span><span class="kw">run_discrete</span>(<span class="dt">model =</span> discrete_model, <span class="dt">data=</span>data, <span class="dt">constants=</span>constants,</span>
<span id="cb3-44"><a href="#cb3-44"></a>        <span class="dt">inits=</span>inits, <span class="dt">params =</span> params,<span class="dt">niter =</span> <span class="dv">5000</span>, <span class="dt">nburnin=</span><span class="dv">1000</span>, </span>
<span id="cb3-45"><a href="#cb3-45"></a>        <span class="dt">thin=</span><span class="dv">1</span>, <span class="dt">nchains=</span><span class="dv">2</span>, <span class="dt">parallel=</span><span class="ot">TRUE</span>,  <span class="dt">RNGseed =</span> <span class="dv">500</span>)</span>
<span id="cb3-46"><a href="#cb3-46"></a><span class="kw">toc</span>()</span>
<span id="cb3-47"><a href="#cb3-47"></a><span class="co">#&gt; 1025.869 sec elapsed</span></span>
<span id="cb3-48"><a href="#cb3-48"></a></span>
<span id="cb3-49"><a href="#cb3-49"></a><span class="co"># histogram of posterior samples for N (abundance)</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>samples =<span class="st"> </span><span class="kw">do.call</span>(rbind, out)</span>
<span id="cb3-51"><a href="#cb3-51"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb3-52"><a href="#cb3-52"></a><span class="kw">hist</span>(samples[,<span class="kw">which</span>(<span class="kw">dimnames</span>(out[[<span class="dv">1</span>]])[[<span class="dv">2</span>]]<span class="op">==</span><span class="st">&quot;N&quot;</span>)], <span class="dt">xlab =</span> <span class="st">&quot;Abundance&quot;</span>, </span>
<span id="cb3-53"><a href="#cb3-53"></a>     <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">400</span>), <span class="dt">main=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb3-54"><a href="#cb3-54"></a><span class="kw">abline</span>(<span class="dt">v=</span>Nsim, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) <span class="co"># add line for simulated abundance</span></span></code></pre></div>
<p align="center">
<img src="../man/figures/vignette_04/Fig2.png" style="width:70%" />
</p>
<br>
<p>
<p>We note that the discrete model takes much longer to run compared to the continuous SCR model equivalent (i.e., ‘classic’ model). This results from using the categorical distribution to sample the pixels of our discrete state-space. In this example we have a somewhat fine grid at 200 m, which results 270 cells that the model has to consider for each individual in our augmented population size of <code>M = 400</code>. We also can’t take advantage of the block sampling of activity center coordinates that greatly speeds up the classic model runs.</p>
<p>We can see from the histogram of the posterior samples of <code>N</code> that our model estimates were close to the simulated value of 200 individuals (shown by red line) and were biased just slightly low at around 196 individuals. This is expected since this is only one realization of the detection process. In this example, we divided the pixelWidth by 1,000 in deriving the area (<code>A</code>) in our list of constants. This allowed us to estimate density in activity centers/km<sup>2</sup> rather than activity centers/m<sup>2</sup>. Note that care must be taken with any rescaling of the data or constants.</p>
<p>Next we use<code>nimSummary()</code> to quickly summarize the MCMC samples. Note that there are other options to summarize MCMC output, but this function is provided with the package and depends partly on the ‘coda’ package. Then, we make a realized density plot of the MCMC samples using <code>realized_density()</code>. In this function we make use of the list of grid and extent we created earlier called <code>Grid</code> as well as our saved coordinates reference system (<code>mycrs</code>). I’ll also note that we need to use the argument <code>discrete = TRUE</code> to indicate that we need to transform the pixel indices saved for <code>s</code> into the state-space grid coordinates. The function will automate this for us.</p>
In this example, we also use the ‘raster’ package to make a simple plot of the realized density output.
</p>
<p><br></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># summarize MCMC samples (exclude parameters and don&#39;t plot)</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">nimSummary</span>(out, <span class="dt">exclude =</span> <span class="kw">c</span>(<span class="st">&quot;s&quot;</span>,<span class="st">&quot;z&quot;</span>), <span class="dt">trace=</span><span class="ot">FALSE</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#&gt;        post.mean post.sd    q2.5     q50   q97.5 f0   n.eff  Rhat</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">#&gt; D         18.222   1.768  15.093  18.148  21.944  1 314.957 1.006</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#&gt; EN       196.003  21.492 157.391 194.404 241.130  1 307.866 1.006</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&gt; N        196.798  19.091 163.000 196.000 237.000  1 314.957 1.006</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&gt; alpha0     2.893   0.110   2.679   2.890   3.106  1 316.798 1.006</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#&gt; p0         0.167   0.023   0.126   0.167   0.214  1 316.707 1.016</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&gt; psi        0.490   0.054   0.393   0.486   0.603  1 307.866 1.006</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#&gt; sigma      0.310   0.021   0.274   0.308   0.358  1 201.439 1.043</span></span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co"># make realized density plot (we don&#39;t use the habitat mask here for </span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co"># discrete model)</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>r =<span class="st"> </span><span class="kw">realized_density</span>(<span class="dt">samples =</span> out, <span class="dt">grid =</span> d_list<span class="op">$</span>grid, <span class="dt">crs_ =</span> mycrs, </span>
<span id="cb4-15"><a href="#cb4-15"></a>                     <span class="dt">site =</span> <span class="ot">NULL</span>, <span class="dt">hab_mask =</span> <span class="ot">FALSE</span>,<span class="dt">discrete=</span><span class="ot">TRUE</span>)       </span>
<span id="cb4-16"><a href="#cb4-16"></a>      </span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co"># load virdiis color palette and raster libraries      </span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="kw">library</span>(viridis)</span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="kw">library</span>(raster)</span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="co"># make simple raster plot</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="kw">plot</span>(r, <span class="dt">col=</span><span class="kw">viridis</span>(<span class="dv">100</span>),</span>
<span id="cb4-23"><a href="#cb4-23"></a>     <span class="dt">main=</span><span class="kw">expression</span>(<span class="st">&quot;Realized density (activity centers/0.2 km&quot;</span><span class="op">^</span><span class="dv">2</span><span class="op">*</span><span class="st">&quot;)&quot;</span>),</span>
<span id="cb4-24"><a href="#cb4-24"></a>     <span class="dt">ylab=</span><span class="st">&quot;Northing&quot;</span>,<span class="dt">xlab=</span><span class="st">&quot;Easting&quot;</span>)</span></code></pre></div>
<p align="center">
<img src="../man/figures/vignette_04/Fig3.png"  style="width:70%" />
</p>
<br>
<p>
</div>
<div id="workflow-for-discrete-scr-model-for-marked-individuals-using-a-3d-trap-array-a-single-scaling-parameter-and-habitat-mask" class="section level3">
<h3>(3) Workflow for discrete SCR model for marked individuals using a 3D trap array, a single scaling parameter and habitat mask</h3>
<p>Next we repeat a similar workflow but now we have two trap arrays that are clustered in space, and thus, there is a negligble chance of detecting an individual at more than one trap array. In this case, the functions in ‘localSCR’ can automatically detect that the traps are in a 3-dimensional format and we note that <code>sim_classic</code> will return a variable called <code>site</code> that identifies which trap array that each individual (both detected and not detected) belongs to. Note that the number of rows in the simulated data <code>y</code> will equal the simulated population size (here in the example, <code>N = 200</code>). However, because we are using a trick provided by Chandler (2018) to separate the data augmentation process into two steps, we only need the encounter data for those individuals that were detected in the model likelihood. Also, because we have no occasion-specific detection covariates, we can sum <code>y</code> over individuals and traps to result in a 2-dimensional encounter history array (i.e., <code>y[i,j]</code>). This speeds up the model under these conditions and we can specify this when we get the SCR model template by setting <code>y_dim = 2</code> in <code>get_classic(y_dim = 2,...)</code>. Otherwise, the workflow is very similar to having a 2-dimensional trap array in the previous example.</p>
</p>
<p><br></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># create an array of traps, as an approach where individuals will only be </span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># detected at one of the trap arrays (e.g., Furnas et al. 2018)</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>Xarray =<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="kw">nrow</span>(traps),<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb5-4"><a href="#cb5-4"></a>Xarray[,,<span class="dv">1</span>]=traps</span>
<span id="cb5-5"><a href="#cb5-5"></a>Xarray[,,<span class="dv">2</span>]=traps<span class="op">+</span><span class="dv">6000</span> <span class="co"># shift trapping grid to new locations</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co"># create grid and extent for 3D trap array</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>GridX =<span class="st"> </span><span class="kw">grid_classic</span>(<span class="dt">X =</span> Xarray, <span class="dt">crs_ =</span> mycrs, <span class="dt">buff =</span> <span class="dv">3</span><span class="op">*</span><span class="kw">max</span>(mysigma), </span>
<span id="cb5-9"><a href="#cb5-9"></a>                     <span class="dt">res =</span> pixelWidth)</span>
<span id="cb5-10"><a href="#cb5-10"></a></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="co"># create polygon to use as a mask</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="kw">library</span>(sf)</span>
<span id="cb5-13"><a href="#cb5-13"></a>poly =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_polygon</span>(<span class="dt">x=</span><span class="kw">list</span>(<span class="kw">matrix</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1660</span>,<span class="op">-</span><span class="dv">1750</span>,<span class="dv">8730</span>,<span class="op">-</span><span class="dv">1050</span>,<span class="dv">7470</span>,</span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="dv">7550</span>,<span class="dv">0</span>,<span class="dv">7950</span>,<span class="op">-</span><span class="dv">1800</span>,<span class="dv">8200</span>,<span class="op">-</span><span class="dv">1660</span>,<span class="op">-</span><span class="dv">1750</span>),<span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>))), <span class="dt">crs =</span>  mycrs)</span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co"># make ggplot</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>g1=<span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">as.data.frame</span>(GridX<span class="op">$</span>grid[,,<span class="dv">1</span>]),</span>
<span id="cb5-18"><a href="#cb5-18"></a>                      <span class="kw">aes</span>(<span class="dt">x=</span>V1,<span class="dt">y=</span>V2),<span class="dt">color=</span><span class="st">&quot;grey60&quot;</span>,<span class="dt">size=</span><span class="fl">1.25</span>) <span class="op">+</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">as.data.frame</span>(Xarray[,,<span class="dv">1</span>]),</span>
<span id="cb5-20"><a href="#cb5-20"></a>               <span class="kw">aes</span>(<span class="dt">x=</span>V1,<span class="dt">y=</span>V2),<span class="dt">color=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">size=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">as.data.frame</span>(GridX<span class="op">$</span>grid[,,<span class="dv">2</span>]),</span>
<span id="cb5-22"><a href="#cb5-22"></a>               <span class="kw">aes</span>(<span class="dt">x=</span>V1,<span class="dt">y=</span>V2),<span class="dt">color=</span><span class="st">&quot;grey60&quot;</span>,<span class="dt">size=</span><span class="fl">1.25</span>) <span class="op">+</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">as.data.frame</span>(Xarray[,,<span class="dv">2</span>]),</span>
<span id="cb5-24"><a href="#cb5-24"></a>               <span class="kw">aes</span>(<span class="dt">x=</span>V1,<span class="dt">y=</span>V2),<span class="dt">color=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">size=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data=</span>poly, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_sf</span>(<span class="dt">datum=</span><span class="kw">st_crs</span>(mycrs)) <span class="op">+</span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="st">    </span><span class="kw">theme_classic</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Northing&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Easting&quot;</span>) <span class="op">+</span></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">limits=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">2000</span>,<span class="dv">9000</span>)) <span class="op">+</span></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">limits=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">2000</span>,<span class="dv">9000</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),</span>
<span id="cb5-30"><a href="#cb5-30"></a>               <span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">16</span>))</span></code></pre></div>
<p align="center">
<img src="../man/figures/vignette_04/Fig4.png" style="width:70%" />
</p>
<br>
<p>
In the figure we can see our two spatially separated trapping grids and that the polgon overlaps some of the gridded area. The area outside the polygon will be considered unsuitable when the habitat matrix is created. Note that the <code>site</code> variable will be only as long as the simulated population size (here, 300) and thus, we will need to augment the variable to have the length equal to the total augmented population size (i.e., <code>M = 600</code>). Otherwise the workflow is very similar to the previous one where we’ll use <code>discretize_classic()</code> to convert our ‘classic’ SCR data to a discrete format. We’ll use some of the items we created above in this example (e.g., <code>mysigma</code>,<code>mycrs</code>).
</p>
<p><br></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># get 3D habitat mask array for 3D grid</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>hab_mask =<span class="st"> </span><span class="kw">mask_polygon</span>(<span class="dt">poly =</span> poly, <span class="dt">grid =</span> GridX<span class="op">$</span>grid, <span class="dt">crs_ =</span> mycrs, </span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="dt">prev_mask =</span> <span class="ot">NULL</span>)</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co"># simuated population size</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>Nsim =<span class="st"> </span><span class="dv">300</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co"># augmented population size</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>M=<span class="dv">600</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co"># simulate data for uniform state-space and habitat mask </span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co"># (N is simulated abundance)</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>data4d =<span class="st"> </span><span class="kw">sim_classic</span>(<span class="dt">X =</span> Xarray, <span class="dt">ext =</span> GridX<span class="op">$</span>ext, <span class="dt">crs_ =</span> mycrs, </span>
<span id="cb6-14"><a href="#cb6-14"></a>                 <span class="dt">sigma_ =</span> mysigma, <span class="dt">prop_sex =</span> <span class="dv">1</span>,<span class="dt">N =</span> Nsim, </span>
<span id="cb6-15"><a href="#cb6-15"></a>                 <span class="dt">K =</span> <span class="dv">4</span>, <span class="dt">base_encounter =</span> <span class="fl">0.15</span>, </span>
<span id="cb6-16"><a href="#cb6-16"></a>                 <span class="dt">enc_dist =</span> <span class="st">&quot;binomial&quot;</span>,<span class="dt">hab_mask =</span> hab_mask, </span>
<span id="cb6-17"><a href="#cb6-17"></a>                 <span class="dt">setSeed =</span> <span class="dv">300</span>)</span>
<span id="cb6-18"><a href="#cb6-18"></a></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co"># augment site identifier</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>site =<span class="st"> </span><span class="kw">c</span>(data4d<span class="op">$</span>site,<span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>,((M<span class="op">-</span><span class="kw">length</span>(data4d<span class="op">$</span>site))<span class="op">/</span><span class="dv">2</span>)),</span>
<span id="cb6-21"><a href="#cb6-21"></a>                       <span class="kw">rep</span>(<span class="dv">2</span>,((M<span class="op">-</span><span class="kw">length</span>(data4d<span class="op">$</span>site))<span class="op">/</span><span class="dv">2</span>))))</span>
<span id="cb6-22"><a href="#cb6-22"></a></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co"># get initial activity center starting values </span></span>
<span id="cb6-24"><a href="#cb6-24"></a>s.st =<span class="st"> </span><span class="kw">initialize_classic</span>(<span class="dt">y=</span>data4d<span class="op">$</span>y, <span class="dt">M=</span>M, <span class="dt">X=</span>Xarray, <span class="dt">ext =</span> GridX<span class="op">$</span>ext, </span>
<span id="cb6-25"><a href="#cb6-25"></a>                            <span class="dt">site =</span> site, <span class="dt">hab_mask =</span> hab_mask)</span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="co"># convert traps and starting locations to discrete format</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>d_list =<span class="st"> </span><span class="kw">discretize_classic</span>(<span class="dt">X=</span>Xarray, <span class="dt">grid =</span> GridX<span class="op">$</span>grid, <span class="dt">s.st =</span> s.st, </span>
<span id="cb6-29"><a href="#cb6-29"></a>                            <span class="dt">crs_ =</span> mycrs,<span class="dt">site=</span>site, <span class="dt">hab_mask =</span> hab_mask)</span>
<span id="cb6-30"><a href="#cb6-30"></a></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co"># inspect discrete data list</span></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="kw">str</span>(d_list)</span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="co">#&gt; List of 4</span></span>
<span id="cb6-34"><a href="#cb6-34"></a><span class="co">#&gt;  $ grid: num [1:284, 1:2, 1:2] -1608 -1408 -1208 -1008 -808 ...</span></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co">#&gt;  $ nPix: int [1:2] 284 278</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="co">#&gt;  $ X   : num [1:25, 1:2, 1:2] -807.71 -407.71 -7.71 392.29 792.29 ...</span></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="co">#&gt;  $ s.st: num [1:600] 98 115 115 165 77 94 77 96 75 109 ...</span></span>
<span id="cb6-38"><a href="#cb6-38"></a></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="co"># prepare data</span></span>
<span id="cb6-40"><a href="#cb6-40"></a>data =<span class="st"> </span><span class="kw">list</span>(<span class="dt">y=</span>data4d<span class="op">$</span>y)</span>
<span id="cb6-41"><a href="#cb6-41"></a>data<span class="op">$</span>y =<span class="st"> </span>data<span class="op">$</span>y[<span class="kw">which</span>(<span class="kw">apply</span>(data<span class="op">$</span>y, <span class="dv">1</span>, sum)<span class="op">!=</span><span class="dv">0</span>),,] <span class="co"># remove augmented records </span></span>
<span id="cb6-42"><a href="#cb6-42"></a><span class="co"># covert to 2d by summing over individuals and traps</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>data<span class="op">$</span>y =<span class="st"> </span><span class="kw">apply</span>(data<span class="op">$</span>y, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), sum) </span>
<span id="cb6-44"><a href="#cb6-44"></a></span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="co"># add discretized traps</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>data<span class="op">$</span>X =<span class="st"> </span>d_list<span class="op">$</span>X <span class="co">#/1000 # convert to km units</span></span>
<span id="cb6-47"><a href="#cb6-47"></a></span>
<span id="cb6-48"><a href="#cb6-48"></a><span class="co"># add grid</span></span>
<span id="cb6-49"><a href="#cb6-49"></a>data<span class="op">$</span>grid =<span class="st"> </span>d_list<span class="op">$</span>grid <span class="co">#/1000 # convert to km units</span></span>
<span id="cb6-50"><a href="#cb6-50"></a></span>
<span id="cb6-51"><a href="#cb6-51"></a><span class="co"># prepare constants (note that density is now in activity centers/km2 </span></span>
<span id="cb6-52"><a href="#cb6-52"></a><span class="co"># and each cell is now 0.02 km2 in area</span></span>
<span id="cb6-53"><a href="#cb6-53"></a>constants =<span class="st"> </span><span class="kw">list</span>(<span class="dt">M =</span> M,<span class="dt">n0 =</span> <span class="kw">nrow</span>(data<span class="op">$</span>y),<span class="dt">J=</span><span class="kw">dim</span>(data<span class="op">$</span>y)[<span class="dv">2</span>],<span class="dt">site=</span>site,</span>
<span id="cb6-54"><a href="#cb6-54"></a>                 <span class="dt">K=</span><span class="kw">dim</span>(data4d<span class="op">$</span>y)[<span class="dv">3</span>],<span class="dt">nPix=</span><span class="kw">sum</span>(d_list<span class="op">$</span>nPix),</span>
<span id="cb6-55"><a href="#cb6-55"></a>                 <span class="dt">pixArea =</span> (pixelWidth<span class="op">^</span><span class="dv">2</span>),</span>
<span id="cb6-56"><a href="#cb6-56"></a>                 <span class="dt">sigma_upper =</span> <span class="dv">1000</span>, </span>
<span id="cb6-57"><a href="#cb6-57"></a>                 <span class="dt">A =</span> (<span class="kw">sum</span>(hab_mask)<span class="op">*</span>((pixelWidth<span class="op">/</span><span class="dv">1000</span>)<span class="op">^</span><span class="dv">2</span>)),</span>
<span id="cb6-58"><a href="#cb6-58"></a>                 <span class="dt">nSites =</span> <span class="kw">dim</span>(d_list<span class="op">$</span>X)[<span class="dv">3</span>])</span>
<span id="cb6-59"><a href="#cb6-59"></a></span>
<span id="cb6-60"><a href="#cb6-60"></a>constants<span class="op">$</span>npixSite =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,d_list<span class="op">$</span>nPix[<span class="dv">1</span>],</span>
<span id="cb6-61"><a href="#cb6-61"></a>                              d_list<span class="op">$</span>nPix[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>,</span>
<span id="cb6-62"><a href="#cb6-62"></a>                              <span class="kw">sum</span>(d_list<span class="op">$</span>nPix)),</span>
<span id="cb6-63"><a href="#cb6-63"></a>                            <span class="dt">ncol=</span><span class="dv">2</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>)</span>
<span id="cb6-64"><a href="#cb6-64"></a></span>
<span id="cb6-65"><a href="#cb6-65"></a><span class="co"># add z and zeros vector data for latent inclusion indicator</span></span>
<span id="cb6-66"><a href="#cb6-66"></a>data<span class="op">$</span>z =<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>,constants<span class="op">$</span>n0),<span class="kw">rep</span>(<span class="ot">NA</span>,constants<span class="op">$</span>M <span class="op">-</span><span class="st"> </span>constants<span class="op">$</span>n0))</span>
<span id="cb6-67"><a href="#cb6-67"></a>data<span class="op">$</span>zeros =<span class="st">  </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="ot">NA</span>,constants<span class="op">$</span>n0),<span class="kw">rep</span>(<span class="dv">0</span>,constants<span class="op">$</span>M <span class="op">-</span><span class="st"> </span>constants<span class="op">$</span>n0))</span>
<span id="cb6-68"><a href="#cb6-68"></a></span>
<span id="cb6-69"><a href="#cb6-69"></a><span class="co"># define all initial values </span></span>
<span id="cb6-70"><a href="#cb6-70"></a>inits =<span class="st"> </span><span class="kw">list</span>(<span class="dt">sigma =</span> <span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">350</span>), <span class="dt">s =</span> d_list<span class="op">$</span>s.st,</span>
<span id="cb6-71"><a href="#cb6-71"></a>            <span class="dt">alpha0 =</span> <span class="fl">-11.25</span>, <span class="dt">p0 =</span> <span class="kw">runif</span>(<span class="kw">dim</span>(d_list<span class="op">$</span>X)[<span class="dv">3</span>], <span class="fl">0.05</span>, <span class="fl">0.15</span>),</span>
<span id="cb6-72"><a href="#cb6-72"></a>            <span class="dt">z=</span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="ot">NA</span>,constants<span class="op">$</span>n0),<span class="kw">rep</span>(<span class="dv">0</span>,constants<span class="op">$</span>M<span class="op">-</span>constants<span class="op">$</span>n0)))</span>
<span id="cb6-73"><a href="#cb6-73"></a></span>
<span id="cb6-74"><a href="#cb6-74"></a><span class="co"># parameters to monitor</span></span>
<span id="cb6-75"><a href="#cb6-75"></a>params =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sigma&quot;</span>,<span class="st">&quot;psi&quot;</span>,<span class="st">&quot;p0&quot;</span>,<span class="st">&quot;N&quot;</span>,<span class="st">&quot;D&quot;</span>,<span class="st">&quot;EN&quot;</span>,<span class="st">&quot;alpha0&quot;</span>,<span class="st">&quot;s&quot;</span>,<span class="st">&quot;z&quot;</span>)</span>
<span id="cb6-76"><a href="#cb6-76"></a></span>
<span id="cb6-77"><a href="#cb6-77"></a><span class="co"># get model</span></span>
<span id="cb6-78"><a href="#cb6-78"></a>discrete_model =<span class="st"> </span><span class="kw">get_discrete</span>(<span class="dt">type=</span><span class="st">&quot;marked&quot;</span>,<span class="dt">dim_y =</span> <span class="dv">2</span>, </span>
<span id="cb6-79"><a href="#cb6-79"></a>              <span class="dt">enc_dist =</span> <span class="st">&quot;binomial&quot;</span>,<span class="dt">sex_sigma =</span> <span class="ot">FALSE</span>,</span>
<span id="cb6-80"><a href="#cb6-80"></a>              <span class="dt">trapsClustered=</span><span class="ot">TRUE</span>)</span>
<span id="cb6-81"><a href="#cb6-81"></a></span>
<span id="cb6-82"><a href="#cb6-82"></a><span class="co"># show model (not run)</span></span>
<span id="cb6-83"><a href="#cb6-83"></a><span class="co"># discrete_model</span></span>
<span id="cb6-84"><a href="#cb6-84"></a></span>
<span id="cb6-85"><a href="#cb6-85"></a><span class="co"># run model (note this was run on a Mac with 16 GB 2667 MHz DDR4 </span></span>
<span id="cb6-86"><a href="#cb6-86"></a><span class="co"># and 2.3 GHz 8-Core Intel Core i9)</span></span>
<span id="cb6-87"><a href="#cb6-87"></a><span class="kw">library</span>(tictoc)</span>
<span id="cb6-88"><a href="#cb6-88"></a><span class="kw">tic</span>() <span class="co"># track time elapsed</span></span>
<span id="cb6-89"><a href="#cb6-89"></a>out =<span class="st"> </span><span class="kw">run_discrete</span>(<span class="dt">model =</span> discrete_model, <span class="dt">data=</span>data, <span class="dt">constants=</span>constants,</span>
<span id="cb6-90"><a href="#cb6-90"></a>        <span class="dt">inits=</span>inits, <span class="dt">params =</span> params,<span class="dt">niter =</span> <span class="dv">5000</span>, <span class="dt">nburnin=</span><span class="dv">1000</span>, </span>
<span id="cb6-91"><a href="#cb6-91"></a>        <span class="dt">thin=</span><span class="dv">1</span>, <span class="dt">nchains=</span><span class="dv">2</span>, <span class="dt">parallel=</span><span class="ot">TRUE</span>,  <span class="dt">RNGseed =</span> <span class="dv">500</span>)</span>
<span id="cb6-92"><a href="#cb6-92"></a><span class="kw">toc</span>()</span>
<span id="cb6-93"><a href="#cb6-93"></a><span class="co">#&gt; 1612.656 sec elapsed</span></span>
<span id="cb6-94"><a href="#cb6-94"></a></span>
<span id="cb6-95"><a href="#cb6-95"></a><span class="co"># histogram of posterior samples for N (abundance)</span></span>
<span id="cb6-96"><a href="#cb6-96"></a>samples =<span class="st"> </span><span class="kw">do.call</span>(rbind, out)</span>
<span id="cb6-97"><a href="#cb6-97"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb6-98"><a href="#cb6-98"></a><span class="kw">hist</span>(samples[,<span class="kw">which</span>(<span class="kw">dimnames</span>(out[[<span class="dv">1</span>]])[[<span class="dv">2</span>]]<span class="op">==</span><span class="st">&quot;EN&quot;</span>)], <span class="dt">xlab =</span> <span class="st">&quot;Expected abundance&quot;</span>, </span>
<span id="cb6-99"><a href="#cb6-99"></a>     <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">600</span>), <span class="dt">main=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb6-100"><a href="#cb6-100"></a><span class="kw">abline</span>(<span class="dt">v=</span>Nsim, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) <span class="co"># add line for simulated abundance</span></span></code></pre></div>
<p align="center">
<img src="../man/figures/vignette_04/Fig5.png" style="width:70%" />
</p>
<p><br></p>
<br>
<p>
<p>We might run a few more iterations to have everything nicely converged, but we won’t do that here given that it took about 20 minutes to run the model. We’ll use<code>nimSummary()</code> to quickly summarize the MCMC samples and check convergence.</p>
We again make a realized density surface and note that the <code>realized_density()</code> function outputs a list of length 2 in this example since we have 2 spatially separated trapping grids here that are in a 3-dimensional array format. I’ll again note that we need to use the argument <code>discrete = TRUE</code> to indicate that we need to transform the pixel indices saved for <code>s</code> into the state-space grid coordinates. The function will automate this for us. We’ll need to provide the extent <code>ext = GridX$ext</code> since we have a 3-dimensional trapping array.
</p>
<p><br></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># summary table of MCMC output (exclude &quot;s&quot; and &quot;z&quot; parameters)</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">nimSummary</span>(out, <span class="dt">exclude =</span> <span class="kw">c</span>(<span class="st">&quot;s&quot;</span>,<span class="st">&quot;z&quot;</span>))</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&gt;        post.mean post.sd    q2.5     q50   q97.5 f0   n.eff  Rhat</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt; D         13.131   1.397  10.676  12.989  16.192  1 175.165 1.011</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt; EN       294.564  33.831 232.157 291.304 367.164  1 178.972 1.011</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&gt; N        295.180  31.395 240.000 292.000 364.000  1 175.165 1.011</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#&gt; alpha0   -11.249   0.114 -11.481 -11.254 -11.022  0 188.347 1.013</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&gt; p0[1]      0.148   0.025   0.104   0.147   0.199  1 294.255 1.033</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&gt; p0[2]      0.128   0.023   0.088   0.127   0.179  1 324.642 1.032</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#&gt; psi        0.491   0.056   0.387   0.486   0.612  1 178.972 1.011</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#&gt; sigma    287.695  23.052 250.820 284.677 339.804  1 139.887 1.103</span></span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co"># generate realized density surface</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>r =<span class="st"> </span><span class="kw">realized_density</span>(<span class="dt">samples=</span>out, <span class="dt">grid=</span>d_list<span class="op">$</span>grid, <span class="dt">ext =</span> GridX<span class="op">$</span>ext,</span>
<span id="cb7-15"><a href="#cb7-15"></a>            <span class="dt">crs_=</span>mycrs,<span class="dt">site=</span>constants<span class="op">$</span>site, <span class="dt">discrete=</span><span class="ot">TRUE</span>)</span>
<span id="cb7-16"><a href="#cb7-16"></a></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co"># load needed packages for multiplot</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="kw">library</span>(viridis) </span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="kw">library</span>(grid)</span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="kw">library</span>(cowplot)</span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="kw">library</span>(ggpubr) </span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="kw">library</span>(rasterVis)</span>
<span id="cb7-23"><a href="#cb7-23"></a></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="co"># plot raster from site 1</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>p1&lt;-<span class="kw">gplot</span>(r[[<span class="dv">1</span>]]) <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> value)) <span class="op">+</span></span>
<span id="cb7-26"><a href="#cb7-26"></a><span class="st">          </span><span class="kw">scale_fill_viridis</span>(<span class="dt">na.value =</span> <span class="ot">NA</span>, <span class="dt">name=</span><span class="st">&quot;Density&quot;</span>,</span>
<span id="cb7-27"><a href="#cb7-27"></a>          <span class="dt">limits=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),<span class="dt">breaks=</span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="fl">1.5</span>,<span class="dt">by=</span><span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb7-28"><a href="#cb7-28"></a><span class="st">          </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_classic</span>() <span class="op">+</span></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="st">          </span><span class="kw">scale_x_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="st">          </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb7-31"><a href="#cb7-31"></a><span class="st">           </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">18</span>))</span>
<span id="cb7-32"><a href="#cb7-32"></a></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="co"># plot raster from site 2</span></span>
<span id="cb7-34"><a href="#cb7-34"></a>p2&lt;-<span class="kw">gplot</span>(r[[<span class="dv">2</span>]]) <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> value)) <span class="op">+</span></span>
<span id="cb7-35"><a href="#cb7-35"></a><span class="st">          </span><span class="kw">scale_fill_viridis</span>(<span class="dt">na.value =</span> <span class="ot">NA</span>, <span class="dt">name=</span><span class="st">&quot;Density&quot;</span>,</span>
<span id="cb7-36"><a href="#cb7-36"></a>          <span class="dt">limits=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),<span class="dt">breaks=</span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="fl">1.5</span>,<span class="dt">by=</span><span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb7-37"><a href="#cb7-37"></a><span class="st">          </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_classic</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb7-38"><a href="#cb7-38"></a><span class="st">          </span><span class="kw">scale_x_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="st">          </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb7-40"><a href="#cb7-40"></a><span class="st">          </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">18</span>))</span>
<span id="cb7-41"><a href="#cb7-41"></a></span>
<span id="cb7-42"><a href="#cb7-42"></a><span class="co"># arrange the two plots in a single row</span></span>
<span id="cb7-43"><a href="#cb7-43"></a>prow &lt;-<span class="st"> </span><span class="kw">plot_grid</span>(p1 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>),</span>
<span id="cb7-44"><a href="#cb7-44"></a>           p2 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>),</span>
<span id="cb7-45"><a href="#cb7-45"></a>           <span class="dt">align =</span> <span class="st">&#39;vh&#39;</span>,</span>
<span id="cb7-46"><a href="#cb7-46"></a>           <span class="dt">labels =</span> <span class="ot">NULL</span>,</span>
<span id="cb7-47"><a href="#cb7-47"></a>           <span class="dt">hjust =</span> <span class="dv">-1</span>,</span>
<span id="cb7-48"><a href="#cb7-48"></a>           <span class="dt">nrow =</span> <span class="dv">1</span></span>
<span id="cb7-49"><a href="#cb7-49"></a>           )</span>
<span id="cb7-50"><a href="#cb7-50"></a></span>
<span id="cb7-51"><a href="#cb7-51"></a><span class="co"># extract the legend from one of the plots</span></span>
<span id="cb7-52"><a href="#cb7-52"></a>legend_t &lt;-<span class="st"> </span><span class="kw">get_legend</span>(p1 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;top&quot;</span>,</span>
<span id="cb7-53"><a href="#cb7-53"></a>                        <span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb7-54"><a href="#cb7-54"></a>                        <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">14</span>),</span>
<span id="cb7-55"><a href="#cb7-55"></a>                        <span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">16</span>)))</span>
<span id="cb7-56"><a href="#cb7-56"></a></span>
<span id="cb7-57"><a href="#cb7-57"></a><span class="co"># add the legend above the row we made earlier. Give it 20% of the height</span></span>
<span id="cb7-58"><a href="#cb7-58"></a><span class="co"># of one plot (via rel_heights).</span></span>
<span id="cb7-59"><a href="#cb7-59"></a>pcomb &lt;-<span class="st"> </span><span class="kw">plot_grid</span>(legend_t, prow, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">rel_heights =</span> <span class="kw">c</span>(.<span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb7-60"><a href="#cb7-60"></a></span>
<span id="cb7-61"><a href="#cb7-61"></a><span class="co"># add x and y axis labels</span></span>
<span id="cb7-62"><a href="#cb7-62"></a>pcomb &lt;-<span class="kw">annotate_figure</span>(pcomb, <span class="dt">bottom =</span> <span class="kw">textGrob</span>(<span class="st">&quot;Easting&quot;</span>, </span>
<span id="cb7-63"><a href="#cb7-63"></a>              <span class="dt">gp=</span><span class="kw">gpar</span>(<span class="dt">fontsize=</span><span class="dv">18</span>), <span class="dt">vjust =</span> <span class="dv">-1</span>, <span class="dt">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb7-64"><a href="#cb7-64"></a>              <span class="dt">left =</span> <span class="kw">textGrob</span>(<span class="st">&quot;Northing&quot;</span>, <span class="dt">rot=</span><span class="dv">90</span>, <span class="dt">gp=</span><span class="kw">gpar</span>(<span class="dt">fontsize=</span><span class="dv">18</span>),</span>
<span id="cb7-65"><a href="#cb7-65"></a>              <span class="dt">vjust =</span> <span class="dv">1</span>, <span class="dt">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb7-66"><a href="#cb7-66"></a>pcomb</span></code></pre></div>
<p align="center">
<img src="../man/figures/vignette_04/Fig6.png" style="width:90%"/>
</p>
<br>
<p>
<p>That’s it for the discrete models! You’ve made it through the fourth ‘localSCR’ tutorial. Please see Royle et al. (2014) for more details about SCR theory and modeling. The next tutorials will focus on applying local approaches to ‘classic’ and discrete SCR models. We’ll see that significant reductions in computational run time can occur with local approaches depending on the problem, but especially for discrete SCR models where we deal with relatively slow run time when there are many pixels to sample from.</p>
</p>
<p><br></p>
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Chandler, R. B. 2018. Speeding up data augmentation in BUGS. <a href="https://groups.google.com/forum/#!topic/hmecology/o6cWDqHHgOE" class="uri">https://groups.google.com/forum/#!topic/hmecology/o6cWDqHHgOE</a>.</p>
<p>de Valpine P, C. Paciorek, D. Turek, N. Michaud, C. Anderson-Bergman, F. Obermeyer, C. C. Wehrhahn, A. Rodrìguez, L. D. Temple, and S. Paganin. 2022. <em>NIMBLE: MCMC, Particle Filtering, and Programmable Hierarchical Modeling</em>. doi: 10.5281/zenodo.1211190 (URL: <a href="https://doi.org/10.5281/zenodo.1211190" class="uri">https://doi.org/10.5281/zenodo.1211190</a>), R package version 0.12.2, URL: <a href="https://cran.r-project.org/package=nimble" class="uri">https://cran.r-project.org/package=nimble</a>.</p>
<p>Furnas, B. J., R. H. Landers, S. Hill, S. S. Itoga, and B. N. Sacks. 2018. Integrated modeling to estimate population size and composition of mule deer. Journal of Wildlife Management 82:1429–1441.</p>
<p>Royle, J. A., R. B. Chandler, R. Sollmann, and B. Gardner. 2014. Spatial capture‐recapture. Academic Press, Waltham, Massachusetts, USA.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
      </div>

</div>



      <footer><div class="copyright">
  <p></p><p>Developed by Daniel Eacker.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer></div>

  


  

  </body></html>
